services:
  redis:
    image: redis:8-alpine
    ports:
      - "6379:6379"

  dynamodb:
    image: amazon/dynamodb-local
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -inMemory -sharedDb"

  dynamodb-init:
    image: amazon/aws-cli
    depends_on:
      dynamodb:
        condition: service_started
    volumes:
      - ./init-scripts:/init-scripts
    entrypoint: ["/bin/sh", "/init-scripts/dynamodb-init.sh"]
    environment:
      AWS_ACCESS_KEY_ID: dummy
      AWS_SECRET_ACCESS_KEY: dummy
      AWS_DEFAULT_REGION: us-east-1
      DYNAMODB_ENDPOINT: ${DYNAMODB_ENDPOINT}
    restart: "no"

  elasticmq:
    image: softwaremill/elasticmq-native
    ports:
      - "9324:9324"

  sqs-init:
    image: amazon/aws-cli
    depends_on:
      elasticmq:
        condition: service_started
    volumes:
      - ./init-scripts:/init-scripts
    entrypoint: ["/bin/sh", "/init-scripts/sqs-init.sh"]
    environment:
      AWS_ACCESS_KEY_ID: dummy
      AWS_SECRET_ACCESS_KEY: dummy
      AWS_DEFAULT_REGION: us-east-1
      SQS_ENDPOINT: ${SQS_ENDPOINT}
    restart: "no"

  app:
    build:
      context: ./app
      dockerfile: Dockerfile
    volumes:
      - ./app:/app
    ports:
      - "${HOST_PORT}:8080"
    environment:
      DEV_MODE: ${DEV_MODE}
      HOST_PORT: ${HOST_PORT}
      DYNAMODB_ENDPOINT: ${DYNAMODB_ENDPOINT}
      SQS_ENDPOINT: ${SQS_ENDPOINT}
      REDIS_ENDPOINT: ${REDIS_ENDPOINT}
      EXTENSION_ID: ${EXTENSION_ID}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      redis:
        condition: service_started
      dynamodb-init:
        condition: service_completed_successfully
      sqs-init:
        condition: service_completed_successfully